# Railway Deployment Checklist for AceApp

## ‚úÖ Pre-Deployment Setup (Completed)

- [x] **Dockerfile Created** - Multi-stage build optimized for production
- [x] **Railway Configuration** - railway.json with proper build settings  
- [x] **Environment Variables Template** - .env.railway.example with all required vars
- [x] **Production Config** - runtime.exs updated with Railway-specific settings
- [x] **Discord OAuth Integration** - Production-ready with dynamic redirect URI
- [x] **Screenshot Service Function** - Railway Function implementation created
- [x] **Database Configuration** - PostgreSQL connection with environment variables
- [x] **Automated Deploy Script** - scripts/deploy.sh for easy deployment

## üöÄ Deployment Steps

### 1. Install Railway CLI
```bash
npm install -g @railway/cli
railway login
```

### 2. Run Automated Deployment
```bash
./scripts/deploy.sh
```

**OR manually:**

### 3. Manual Deployment Steps

1. **Create Railway Project**
   ```bash
   railway create --name ace-app
   ```

2. **Add PostgreSQL Service**
   ```bash
   railway add postgresql
   ```

3. **Set Environment Variables**
   ```bash
   # Generate secret key
   SECRET_KEY_BASE=$(mix phx.gen.secret)
   railway variables set SECRET_KEY_BASE="$SECRET_KEY_BASE"
   
   # Discord OAuth (get from https://discord.com/developers/applications)
   railway variables set DISCORD_CLIENT_ID="your_client_id"
   railway variables set DISCORD_CLIENT_SECRET="your_client_secret"
   
   # Production settings
   railway variables set MIX_ENV="prod"
   railway variables set PHX_SERVER="true"
   
   # Optional: Admin user IDs
   railway variables set ADMIN_DISCORD_IDS="comma,separated,discord,user,ids"
   ```

4. **Deploy Main Application**
   ```bash
   railway up --detach
   ```

5. **Deploy Screenshot Service**
   ```bash
   cd railway-functions/screenshot
   railway functions deploy
   railway variables set SCREENSHOT_SERVICE_URL="https://your-function-url.railway.app"
   ```

6. **Update Discord OAuth Redirect URI**
   - Get your Railway domain: `railway domain`
   - Add `https://your-domain.railway.app/auth/discord/callback` to Discord app

### 4. Post-Deployment Verification

1. **Check Application Health**
   ```bash
   railway logs --tail
   railway open
   ```

2. **Test Core Features**
   - [ ] Landing page loads correctly
   - [ ] Discord OAuth login works
   - [ ] Draft creation functionality
   - [ ] Screenshot service responds
   - [ ] Database operations work

3. **Initialize Game Data**
   ```bash
   railway run mix setup_game_data
   ```

## üîß Environment Variables Reference

### Required Variables
- `DATABASE_URL` - Auto-generated by Railway PostgreSQL
- `SECRET_KEY_BASE` - Generated via `mix phx.gen.secret`
- `DISCORD_CLIENT_ID` - From Discord Developer Portal
- `DISCORD_CLIENT_SECRET` - From Discord Developer Portal
- `SCREENSHOT_SERVICE_URL` - Railway Function URL
- `PHX_SERVER` - Set to "true"
- `MIX_ENV` - Set to "prod"

### Optional Variables
- `PHX_HOST` - Auto-detected from Railway domain
- `PORT` - Auto-detected (typically 4000)
- `DISCORD_REDIRECT_URI` - Auto-generated if not set
- `ADMIN_DISCORD_IDS` - Comma-separated Discord user IDs for admin access
- `POOL_SIZE` - Database connection pool size (default: 10)

## üõ†Ô∏è Troubleshooting

### Common Issues

1. **Build Failures**
   - Check `railway logs` for detailed error messages
   - Ensure all environment variables are set
   - Verify Dockerfile syntax

2. **Database Connection Issues**
   - Ensure PostgreSQL service is added
   - Check `DATABASE_URL` is properly set
   - Run migrations: `railway run mix ecto.migrate`

3. **Discord OAuth Issues**
   - Verify Discord app redirect URI matches Railway domain
   - Check client ID and secret are correct
   - Ensure redirect URI uses HTTPS

4. **Screenshot Service Issues**
   - Verify Railway Function is deployed
   - Check `SCREENSHOT_SERVICE_URL` environment variable
   - Test function directly via Railway dashboard

### Helpful Commands
```bash
# Check deployment status
railway ps

# View logs
railway logs --tail

# Open application
railway open

# Run database migrations
railway run mix ecto.migrate

# Populate game data
railway run mix setup_game_data

# Access Railway shell
railway shell
```

## üéØ Success Criteria

Deployment is successful when:
- [x] Application builds without errors
- [x] Database migrations run successfully
- [x] Discord OAuth login works
- [x] Screenshot service responds
- [x] Core draft functionality works
- [x] Game data is populated
- [x] Admin access works (if configured)

## üìö Additional Resources

- [Railway Documentation](https://docs.railway.app)
- [Phoenix Deployment Guide](https://hexdocs.pm/phoenix/deployment.html)
- [Elixir Release Documentation](https://hexdocs.pm/mix/Mix.Tasks.Release.html)
- [Discord OAuth Documentation](https://discord.com/developers/docs/topics/oauth2)